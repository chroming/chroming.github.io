<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Python,多进程," />





  <link rel="alternate" href="/atom.xml" title="司开星的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="多进程Linux 系统linux系统可通过os.fork()复制当前进程状态作为子进程。复制时子进程返回0,父进程返回子进程的pid. 子进程可通过os.getppid()获取父进程的pid.同时os.getpid()可获得当前进程的pid.
12345678import osprint &apos;Process (%s) start...&apos; % os.getpid()pid = os.fork()if">
<meta property="og:type" content="article">
<meta property="og:title" content="Python中的多进程，多线程，协程">
<meta property="og:url" content="sikaixing.com/2016/01/21/multiprocess_in_python/index.html">
<meta property="og:site_name" content="司开星的博客">
<meta property="og:description" content="多进程Linux 系统linux系统可通过os.fork()复制当前进程状态作为子进程。复制时子进程返回0,父进程返回子进程的pid. 子进程可通过os.getppid()获取父进程的pid.同时os.getpid()可获得当前进程的pid.
12345678import osprint &apos;Process (%s) start...&apos; % os.getpid()pid = os.fork()if">
<meta property="og:updated_time" content="2016-08-21T14:26:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python中的多进程，多线程，协程">
<meta name="twitter:description" content="多进程Linux 系统linux系统可通过os.fork()复制当前进程状态作为子进程。复制时子进程返回0,父进程返回子进程的pid. 子进程可通过os.getppid()获取父进程的pid.同时os.getpid()可获得当前进程的pid.
12345678import osprint &apos;Process (%s) start...&apos; % os.getpid()pid = os.fork()if">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="sikaixing.com/2016/01/21/multiprocess_in_python/"/>





  <title> Python中的多进程，多线程，协程 | 司开星的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c7ff29f060abd4d184d8c4d40dbe6a17";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">司开星的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="sikaixing.com/2016/01/21/multiprocess_in_python/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="司开星">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="司开星的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="司开星的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Python中的多进程，多线程，协程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-21T00:16:21+08:00">
              2016-01-21
            </time>

            &nbsp;|&nbsp;

            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-check-o"></i>
            </span>
            <time title="Post modified" itemprop="dateModified" datetime="2016-08-21T22:26:43+08:00">
              2016-08-21
            </time>
            
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程语言/" itemprop="url" rel="index">
                    <span itemprop="name">编程语言</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编程语言/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
             <span id="/2016/01/21/multiprocess_in_python/" class="leancloud_visitors" data-flag-title="Python中的多进程，多线程，协程">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h2><h3 id="Linux-系统"><a href="#Linux-系统" class="headerlink" title="Linux 系统"></a>Linux 系统</h3><p>linux系统可通过<code>os.fork()</code>复制当前进程状态作为子进程。复制时子进程返回0,父进程返回子进程的pid. 子进程可通过<code>os.getppid()</code>获取父进程的pid.同时<code>os.getpid()</code>可获得当前进程的pid.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">'Process (%s) start...'</span> % os.getpid()</div><div class="line">pid = os.fork()</div><div class="line"><span class="keyword">if</span> pid==<span class="number">0</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">'I am child process (%s) and my parent is %s.'</span> % (os.getpid(),                os.getppid())</div><div class="line"><span class="keyword">else</span>:</div><div class="line"><span class="keyword">print</span> <span class="string">'I (%s) just created a child process (%s).'</span> % (os.getpid(), pid)</div></pre></td></tr></table></figure>
<p>结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Process (876) start...</div><div class="line">I (876) just created a child process (877).</div><div class="line">I am child process (877) and my parent is 876.</div></pre></td></tr></table></figure>
<h3 id="Python自带的多进程模块"><a href="#Python自带的多进程模块" class="headerlink" title="Python自带的多进程模块"></a>Python自带的多进程模块</h3><p>windows没有<code>fork()</code>.可以通过python提供的通用多进程模块<code>multiprocessing</code>创建多进程。</p>
<pre><code>  创建多进程需要导入`Process`模块:

  `from multiprocess import Process`

  使用

  `p = Process(target=function, args=(parament,...)`

  创建子进程实例.其中`target=`传入子进程需执行的*函数本身*`function`,args传入函数需要的参数.参数数量不固定.
  之后使用

  `p.start()`

  运行实例.要等待该子进程运行结束再运行之后的代码可以使用:

  `p.join()`

  以下是一个例子:

​<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</div><div class="line">  <span class="keyword">import</span> os</div><div class="line">  </div><div class="line">  <span class="comment"># 子进程要执行的代码</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run_proc</span><span class="params">(name)</span>:</span></div><div class="line">      <span class="keyword">print</span> <span class="string">'Run child process %s (%s)...'</span> % (name, os.getpid())</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">      <span class="keyword">print</span> <span class="string">'Parent process %s.'</span> % os.getpid()</div><div class="line">      p = Process(target=run_proc, args=(<span class="string">'test'</span>,))</div><div class="line">      <span class="keyword">print</span> <span class="string">'Process will start.'</span></div><div class="line">      p.start()</div><div class="line">      p.join()</div><div class="line">      <span class="keyword">print</span> <span class="string">'Process end.'</span></div><div class="line">​</div></pre></td></tr></table></figure>

  结果:

  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Parent process 928.</div><div class="line">Process will start.</div><div class="line">Run child process test (929)...</div><div class="line">Process end.</div></pre></td></tr></table></figure>
</code></pre><p>对于需启动大量子进程的情况,可使用<code>Pool</code>模块:</p>
<pre><code>    `from multiprocessing import Pool`

    使用:

    `p = Pool(number)`

    创建进程池.其中number为进程池包含子进程数量.不写默认为CPU核数.

    使用:
    `p.map(function,inter)`
    `p.map_async(function,inter)`
    `p.apply(function, args=(parament,...)`
    `p.apply_async(function, args=(parament,...)`
    其中之一同时运行子进程.其中map只支持单个参数.inter为可迭代对象.async为非阻塞方式运行，即不等结果出来主程序也会继续运行后面的代码。而apply输入则是一个list中的数量超过一个的参数。

    之后需关闭进程池:

    `p.close()`

    同时,需等待所有子进程运行结束可使用:

    `p.join()`

    简单的例子：

    ​<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">        from multiprocessing import Pool</div><div class="line">​    ​    import os </div><div class="line">        def Pri(x):</div><div class="line">            print x*x</div><div class="line">            print os.getpid()</div><div class="line">            </div><div class="line">        p = Pool(5)</div><div class="line">        for i in range(10):</div><div class="line">            p.apply_async(Pri, [i])</div><div class="line">            p.close()</div><div class="line">        ​</div></pre></td></tr></table></figure>


    ​<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">        from multiprocessing import Pool</div><div class="line">​    ​    import os </div><div class="line">        def Pri(x):</div><div class="line">            print x*x</div><div class="line">            print os.getpid()</div><div class="line">            </div><div class="line">        p = Pool(5)</div><div class="line">        p.map(Pri, range(10))</div><div class="line">        p.close()</div><div class="line">        ​</div></pre></td></tr></table></figure>


    另一个例子:

​<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</div><div class="line">    <span class="keyword">import</span> os, time, random</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">long_time_task</span><span class="params">(name)</span>:</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'Run task %s (%s)...'</span> % (name, os.getpid())</div><div class="line">        start = time.time()</div><div class="line">        time.sleep(random.random() * <span class="number">3</span>)</div><div class="line">        end = time.time()</div><div class="line">        <span class="keyword">print</span> <span class="string">'Task %s runs %0.2f seconds.'</span> % (name, (end - start))</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'Parent process %s.'</span> % os.getpid()</div><div class="line">        p = Pool()</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">            p.apply_async(long_time_task, args=(i,))</div><div class="line">        <span class="keyword">print</span> <span class="string">'Waiting for all subprocesses done...'</span></div><div class="line">        p.close()</div><div class="line">        p.join()</div><div class="line">        <span class="keyword">print</span> <span class="string">'All subprocesses done.'</span></div><div class="line">​</div></pre></td></tr></table></figure>


    结果:

    ​<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Parent process 669.</div><div class="line">Waiting for all subprocesses done...</div><div class="line">Run task 0 (671)...</div><div class="line">Run task 1 (672)...</div><div class="line">Run task 2 (673)...</div><div class="line">Run task 3 (674)...</div><div class="line">Task 2 runs 0.14 seconds.</div><div class="line">Run task 4 (673)...</div><div class="line">Task 1 runs 0.27 seconds.</div><div class="line">Task 3 runs 0.86 seconds.</div><div class="line">Task 0 runs 1.41 seconds.</div><div class="line">Task 4 runs 1.91 seconds.</div><div class="line">All subprocesses done.</div><div class="line">​</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>进程间通讯</p>
<pre><code>不同进程间可以通过`Queue`,`Pipe`来通信.`Pipe`用于两个进程间通信,`Quene`用于多个进程间通信.在只有两个进程通信的情况下`Pipe`效率高于`Queue`.
</code></pre><ul>
<li><p>Pipe</p>
<p>  导入<code>Pipe</code>模块:</p>
<p>  <code>from multiprocessing import Pipe</code></p>
<p>  创建Pipe通信的两端(返回一个双元素的list):</p>
<p>  <code>p = Pipe(duplex=False)</code><br>  其中<code>duplex=False</code>表示该<code>Pipe只</code>能单向通信.默认不写该参数为双向通信.</p>
<p>  <code>p[0]</code>,<code>p[1]</code>可以分别作为两个子进程的参数传递给子进程函数.也可以只传递一端给子进程,另一端交给父进程.</p>
<p>  <code>Pipe</code>的两端可通过<code>p.send()</code>传送值,<code>p.recv()</code>接收值.</p>
<p>  例子1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Pipe</div><div class="line">       </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(conn)</span>:</span></div><div class="line">    conn.send([<span class="number">42</span>, <span class="keyword">None</span>, <span class="string">'hello'</span>])</div><div class="line">    conn.close()</div><div class="line"> </div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    parent_conn, child_conn = Pipe()</div><div class="line">    p = Process(target=f, args=(child_conn,))</div><div class="line">    p.start()</div><div class="line">    <span class="keyword">print</span> parent_conn.recv()   <span class="comment"># prints "[42, None, 'hello']"</span></div><div class="line">    p.join()</div></pre></td></tr></table></figure>
<p>  例子2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> multiprocessing <span class="keyword">as</span> mul</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">proc1</span><span class="params">(pipe)</span>:</span></div><div class="line">    pipe.send(<span class="string">'hello'</span>)</div><div class="line">    print(<span class="string">'proc1 rec:'</span>,pipe.recv())</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">proc2</span><span class="params">(pipe)</span>:</span></div><div class="line">    print(<span class="string">'proc2 rec:'</span>,pipe.recv())</div><div class="line">    pipe.send(<span class="string">'hello, too'</span>)</div><div class="line"></div><div class="line"><span class="comment"># Build a pipe</span></div><div class="line">pipe = mul.Pipe()</div><div class="line"></div><div class="line"><span class="comment"># Pass an end of the pipe to process 1</span></div><div class="line">p1   = mul.Process(target=proc1, args=(pipe[<span class="number">0</span>],))</div><div class="line"><span class="comment"># Pass the other end of the pipe to process 2</span></div><div class="line">p2   = mul.Process(target=proc2, args=(pipe[<span class="number">1</span>],))</div><div class="line">p1.start()</div><div class="line">p2.start()</div><div class="line">p1.join()</div><div class="line">p2.join()</div></pre></td></tr></table></figure>
</li>
<li><p>Queue</p>
<p>  导入<code>Queue</code>模块:</p>
<p>  <code>from multiprocessing import Queue</code></p>
<p>  创建<code>Queue</code>对象:</p>
<p>  <code>q = Queue(max)</code><br>  其中max表示对象中可以存放的最大数量.</p>
<p>  q可作为全局变量使用,也可以作为参数传递给子进程.<br>  使用<code>q.put()</code>在<code>Queue</code>对象中放入需传递的值,<code>q.get()</code>取出值.</p>
<p>  例子1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process,Queue</div><div class="line">       </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">writer_proc</span><span class="params">()</span>:</span></div><div class="line">   q.put(<span class="number">100</span>)</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">reader_proc</span><span class="params">()</span>:</span></div><div class="line">   <span class="keyword">print</span> q.get()</div><div class="line"> </div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    q = Queue()</div><div class="line">    reader = Process(target=reader_proc,args=(q,))</div><div class="line">    reader.start()</div><div class="line">    writer = Process(target=writer_proc,args=(q,))</div><div class="line">    writer.start()</div><div class="line">    reader.join()</div><div class="line">    writer.join()</div></pre></td></tr></table></figure>
<p>  例子2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line">       </div><div class="line">q = multiprocessing.Queue()</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">reader_proc</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> q.get()</div><div class="line"> </div><div class="line">reader = multiprocessing.Process(target=reader_proc)</div><div class="line">reader.start()</div><div class="line"> </div><div class="line">q.put(<span class="number">100</span>)</div><div class="line">reader.join()</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p>多任务除了使用多进程外还可以使用多线程来完成.单个进程中可以有多个线程,它们共享进程中的数据.<br>​<br>python中可使用高级模块<code>Threading</code>来创建多线程.其使用方法与<code>multiprocessing</code>相似.</p>
<p>导入<code>Threading</code>模块:</p>
<p><code>import Threading</code></p>
<p><em>threading 模块提供的常用方法：<br>threading.currentThread(): 返回当前的线程变量。 (也可以使用threading.current_thread())<br>threading.enumerate(): 返回一个包含正在运行的线程的list。正在运行指线程启动后、结束前，不包括启动前和终止后的线程。<br>threading.activeCount(): 返回正在运行的线程数量，与len(threading.enumerate())有相同的结果。<br>threading模块提供的类：<br>Thread, Lock, Rlock, Condition, [Bounded]Semaphore, Event, Timer, local.</em></p>
<p>构建新线程实例:</p>
<p><code>t = Threading.thread(target=function,...)</code><br>同时构建实例支持以下几种方法:</p>
<p><em>Thread(group=None, target=None, name=None, args=(), kwargs={})<br>group: 线程组，目前还没有实现，库引用中提示必须是None；<br>target: 要执行的方法；<br>name: 线程名；<br>args/kwargs: 要传入方法的参数。</em></p>
<p>实例支持以下方法:<br><em>isAlive(): 返回线程是否在运行。正在运行指启动后、终止前。<br>get/setName(name): 获取/设置线程名。<br>is/setDaemon(bool): 获取/设置是否守护线程。初始值从创建该线程的线程继承。当没有非守护线程仍在运行时，程序将终止。<br>start(): 启动线程。<br>join([timeout]): 阻塞当前上下文环境的线程，直到调用此方法的线程终止或到达指定的timeout（可选参数）。</em></p>
<p>使用:</p>
<p><code>t.start()</code><br>运行新线程.</p>
<p>如需等待线程运行结束:</p>
<p><code>t.join()</code></p>
<ul>
<li><p>锁<br>  由于多线程共享进程中的变量, 如果直接使用多线程修改变量的话容易出问题.所以多线程中一般会创建锁.</p>
<p>  创建锁:</p>
<p>  <code>lock = threading.Lock()</code><br>  此时有了一个锁的实例.</p>
<p>  <em>锁的实例方法:<br>  acquire([timeout]): 使线程进入同步阻塞状态，尝试获得锁定。<br>  release(): 释放锁。使用前线程必须已获得锁定，否则将抛出异常。</em></p>
<p>  在每个线程需要修改变量前调用实例方法,尝试将修改变量的过程置于锁中,不让其他线程修改变量:</p>
<p>  <code>lock.acquire()</code></p>
<p>  修改之后需要释放锁:</p>
<p>  <code>lock.release()</code></p>
<p>  例子1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">balance = <span class="number">0</span></div><div class="line">lock = threading.Lock()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_thread</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</div><div class="line">        <span class="comment"># 先要获取锁:</span></div><div class="line">        lock.acquire()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment"># 放心地改吧:</span></div><div class="line">            change_it(n)</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            <span class="comment"># 改完了一定要释放锁:</span></div><div class="line">            lock.release()</div></pre></td></tr></table></figure>
<p>  例子2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># encoding: UTF-8</span></div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> time</div><div class="line"> </div><div class="line">data = <span class="number">0</span></div><div class="line">lock = threading.Lock()</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> data</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s acquire lock...'</span> % threading.currentThread().getName()</div><div class="line">    </div><div class="line">    <span class="comment"># 调用acquire([timeout])时，线程将一直阻塞，</span></div><div class="line">    <span class="comment"># 直到获得锁定或者直到timeout秒后（timeout参数可选）。</span></div><div class="line">    <span class="comment"># 返回是否获得锁。</span></div><div class="line">    <span class="keyword">if</span> lock.acquire():</div><div class="line">        <span class="keyword">print</span> <span class="string">'%s get the lock.'</span> % threading.currentThread().getName()</div><div class="line">        data += <span class="number">1</span></div><div class="line">        time.sleep(<span class="number">2</span>)</div><div class="line">        <span class="keyword">print</span> <span class="string">'%s release lock...'</span> % threading.currentThread().getName()</div><div class="line">        </div><div class="line">        <span class="comment"># 调用release()将释放锁。</span></div><div class="line">        lock.release()</div><div class="line"> </div><div class="line">t1 = threading.Thread(target=func)</div><div class="line">t2 = threading.Thread(target=func)</div><div class="line">t3 = threading.Thread(target=func)</div><div class="line">t1.start()</div><div class="line">t2.start()</div><div class="line">t3.start()</div></pre></td></tr></table></figure>
<p>  其他锁及线程间通信见参考资料5中.</p>
</li>
<li><p>多线程的全局变量与局部变量<br>  多线程之间修改全局变量需要加锁. 在线程的函数中创建局部变量可以解决加锁问题, 但如果线程需要运行不同函数, 函数之间需要共享变量, 局部变量调用不是很方便. <code>threading.local()</code>可以解决这个问题.<br>  <code>localschool = threading.local()</code></p>
<p>  创建实例后, 不同线程在同时使用实例时不会产生冲突.</p>
<p>  例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"></div><div class="line"><span class="comment"># 创建全局ThreadLocal对象:</span></div><div class="line">local_school = threading.local()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_student</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Hello, %s (in %s)'</span> % (local_school.student, threading.current_thread().name)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_thread</span><span class="params">(name)</span>:</span></div><div class="line">    <span class="comment"># 绑定ThreadLocal的student:</span></div><div class="line">    local_school.student = name</div><div class="line">    process_student()</div><div class="line"></div><div class="line">t1 = threading.Thread(target= process_thread, args=(<span class="string">'Alice'</span>,), name=<span class="string">'Thread-A'</span>)</div><div class="line">t2 = threading.Thread(target= process_thread, args=(<span class="string">'Bob'</span>,), name=<span class="string">'Thread-B'</span>)</div><div class="line">t1.start()</div><div class="line">t2.start()</div><div class="line">t1.join()</div><div class="line">t2.join()</div></pre></td></tr></table></figure>
</li>
<li><p>分布式进程(待完善</p>
</li>
</ul>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>协程是单线程在不同的函数间中断并相互切换的一种运行模式.比如在函数A运行遇到阻塞时转向运行函数B,等到函数B运行结束再回来接着运行函数A.与多线程相比协程没有锁的问题.协程可以在IO密集的程序中节省IO等待时间,提高运行效率.</p>
<ul>
<li><p>yield<br>  python的生成器<code>yield</code>一定程度上支持协程.定义生成器<code>yield</code>可以直接在函数定义中将<code>return</code>换成<code>yield</code>.在调用生成器函数时首先将生成器赋给变量,通过变量的<code>.next()</code>方法调用生成器生成第一个值.再次调用<code>.next()</code>方法可生成第二个值.<code>.send(value)</code>方法可在调用生成器时给它传递一个参数.<br>  例子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></div><div class="line">    r = <span class="string">''</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        n = <span class="keyword">yield</span> r</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n:</div><div class="line">            <span class="keyword">return</span></div><div class="line">        print(<span class="string">'[CONSUMER] Consuming %s...'</span> % n)</div><div class="line">        time.sleep(<span class="number">1</span>)</div><div class="line">        r = <span class="string">'200 OK'</span></div><div class="line">     </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(c)</span>:</span></div><div class="line">    c.next()</div><div class="line">    n = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</div><div class="line">        n = n + <span class="number">1</span></div><div class="line">        print(<span class="string">'[PRODUCER] Producing %s...'</span> % n)</div><div class="line">        r = c.send(n)</div><div class="line">        print(<span class="string">'[PRODUCER] Consumer return: %s'</span> % r)</div><div class="line">    c.close()</div><div class="line">     </div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">    c = consumer()</div><div class="line">    produce(c)</div></pre></td></tr></table></figure>
<p>  结果:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[PRODUCER] Producing 1...</div><div class="line">[CONSUMER] Consuming 1...</div><div class="line">[PRODUCER] Consumer return: 200 OK</div><div class="line">[PRODUCER] Producing 2...</div><div class="line">[CONSUMER] Consuming 2...</div><div class="line">[PRODUCER] Consumer return: 200 OK</div><div class="line">[PRODUCER] Producing 3...</div><div class="line">[CONSUMER] Consuming 3...</div><div class="line">[PRODUCER] Consumer return: 200 OK</div><div class="line">[PRODUCER] Producing 4...</div><div class="line">[CONSUMER] Consuming 4...</div><div class="line">[PRODUCER] Consumer return: 200 OK</div><div class="line">[PRODUCER] Producing 5...</div><div class="line">[CONSUMER] Consuming 5...</div><div class="line">[PRODUCER] Consumer return: 200 OK</div></pre></td></tr></table></figure>
<p>  更多关于<code>yield</code>见参考资料6.</p>
</li>
<li><p>gevent</p>
<pre><code>gevent模块为python提供了完整的协程实现.

使用需先导入模块:

`import gevent`
</code></pre><ul>
<li><p>在网络通信中一般还会导入<code>monkey</code>模块以将默认<code>socket</code>替换为可协程的<code>socket</code>:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">from gevent import monkey</div><div class="line">monkey.patch_socket()</div></pre></td></tr></table></figure>
<p>  或者将所有阻塞式调用,包括<code>socket</code>, <code>ssl</code>, <code>threading</code>, <code>select</code>都替换为异步式:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">from gevent import monkey</div><div class="line">monkey.patch_all()</div></pre></td></tr></table></figure>
<p>  这种替换调用一般放在第一行.替换后这些调用会自动处理阻塞问题.</p>
<p>  在需使用协程时要用:</p>
<p>  <code>g = gevent.spawn(function,parament)</code><br>  使用协程方式启动函数.参数为函数的参数.</p>
<p>  等待任务结束可以使用:</p>
<p>  <code>g.join()</code></p>
<p>  等待所有任务结束可以使用:</p>
<p>  <code>gevent.joinall(spawnlist)</code></p>
</li>
<li><p>不过使用<code>monkey</code>模块补丁自动处理有时候不能满足要求.这时我们可以使用其他模块.<br>如自动处理会并发所有连接,如果需要限制并发数量的话可以使用<code>Pool</code>模块.</p>
<p>  <code>from gevent.pool import Pool</code></p>
<p>  新建一个<code>Pool</code>池:</p>
<p>  <code>p = Pool(number)</code><br>  number为最高并发数</p>
<p>  在并发池中启动函数:</p>
<p>  <code>p.spawn(function,parament)</code></p>
<p>  等待所有任务结束:</p>
<p>  <code>p.join()</code></p>
</li>
<li><p>需要直接指定跳转时用<code>sleep</code>函数:</p>
<p>  <code>gevent.sleep(time)</code><br>  其中<code>time</code>表示此处至少要阻塞time秒.</p>
</li>
</ul>
</li>
</ul>
<p>参考资料:</p>
<ol>
<li><p><code>&lt;&lt;多进程&gt;&gt;</code><br> <a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0013868323401155ceb3db1e2044f80b974b469eb06cb43000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0013868323401155ceb3db1e2044f80b974b469eb06cb43000</a></p>
</li>
<li><p><code>&lt;&lt;Python多进程并发(multiprocessing)&gt;&gt;</code><br> <a href="http://www.coder4.com/archives/3352" target="_blank" rel="external">http://www.coder4.com/archives/3352</a></p>
</li>
<li><p><code>&lt;&lt;Python标准库10 多进程初步 (multiprocessing包)&gt;&gt;</code><br> <a href="http://www.cnblogs.com/vamei/archive/2012/10/12/2721484.html" target="_blank" rel="external">http://www.cnblogs.com/vamei/archive/2012/10/12/2721484.html</a></p>
</li>
<li><p><code>&lt;&lt;python多线程模块multiprocessing的进程间通信&gt;&gt;</code><br> <a href="https://blog.weizhe.net/?p=77" target="_blank" rel="external">https://blog.weizhe.net/?p=77</a></p>
</li>
<li><p><code>&lt;&lt;Python线程指南&gt;&gt;</code><br> <a href="http://www.cnblogs.com/huxi/archive/2010/06/26/1765808.html" target="_blank" rel="external">http://www.cnblogs.com/huxi/archive/2010/06/26/1765808.html</a></p>
</li>
<li><p><code>&lt;&lt;生成器&gt;&gt;</code><br> <a href="http://wiki.jikexueyuan.com/project/start-learning-python/215.html" target="_blank" rel="external">http://wiki.jikexueyuan.com/project/start-learning-python/215.html</a></p>
</li>
<li><p><code>&lt;&lt;Gevent Introduction&gt;&gt;</code> <a href="http://www.gevent.org/intro.html#installation-and-requirements" target="_blank" rel="external">http://www.gevent.org/intro.html#installation-and-requirements</a></p>
</li>
<li>《python 进程池2 - Pool相关函数》<a href="http://www.cnblogs.com/congbo/archive/2012/08/23/2652490.html" target="_blank" rel="external">http://www.cnblogs.com/congbo/archive/2012/08/23/2652490.html</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/多进程/" rel="tag"># 多进程</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/11/24/secure-crt-command/" rel="next" title="SecureCRT命令行参数">
                <i class="fa fa-chevron-left"></i> SecureCRT命令行参数
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/03/01/mac-aircrack-ng/" rel="prev" title="Mac下使用aircrack-ng记录">
                Mac下使用aircrack-ng记录 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="司开星" />
          <p class="site-author-name" itemprop="name">司开星</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/chroming" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/chromerplus" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/chroming" target="_blank" title="CSND">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  CSND
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-nd.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#多进程"><span class="nav-number">1.</span> <span class="nav-text">多进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux-系统"><span class="nav-number">1.1.</span> <span class="nav-text">Linux 系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python自带的多进程模块"><span class="nav-number">1.2.</span> <span class="nav-text">Python自带的多进程模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多线程"><span class="nav-number">2.</span> <span class="nav-text">多线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#协程"><span class="nav-number">3.</span> <span class="nav-text">协程</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">司开星</span>
</div>



        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("7i5MUsWXY3NmljUbNIYbB5G3-gzGzoHsz", "1UYFkJkKuvoUs4MANdHnFxS7");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
